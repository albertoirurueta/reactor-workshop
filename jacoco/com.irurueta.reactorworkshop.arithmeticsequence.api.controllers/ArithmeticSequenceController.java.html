<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArithmeticSequenceController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">com.irurueta:reactor-workshop</a> &gt; <a href="index.source.html" class="el_package">com.irurueta.reactorworkshop.arithmeticsequence.api.controllers</a> &gt; <span class="el_source">ArithmeticSequenceController.java</span></div><h1>ArithmeticSequenceController.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2021 Alberto Irurueta Carro (alberto@irurueta.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.irurueta.reactorworkshop.arithmeticsequence.api.controllers;

import com.irurueta.reactorworkshop.arithmeticsequence.api.dto.MultipleArithmeticSequenceDetailDto;
import com.irurueta.reactorworkshop.arithmeticsequence.api.dto.MultipleArithmeticSequenceSummaryDto;
import com.irurueta.reactorworkshop.arithmeticsequence.api.dto.factories.MultipleArithmeticSequenceDetailDtoFactory;
import com.irurueta.reactorworkshop.arithmeticsequence.api.dto.factories.MultipleArithmeticSequenceSummaryDtoFactory;
import com.irurueta.reactorworkshop.arithmeticsequence.api.mappers.MultipleArithmeticSequenceDataMapper;
import com.irurueta.reactorworkshop.arithmeticsequence.api.mappers.SingleArithmeticSequenceResultMapper;
import com.irurueta.reactorworkshop.arithmeticsequence.domain.entities.SingleArithmeticSequenceResult;
import com.irurueta.reactorworkshop.arithmeticsequence.domain.services.ArithmeticSequenceValidationService;
import com.irurueta.reactorworkshop.arithmeticsequence.domain.services.MultipleArithmeticSequenceService;
import com.irurueta.reactorworkshop.arithmeticsequence.domain.services.ReactiveMultipleArithmeticSequenceService;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import reactor.core.publisher.Mono;

import java.time.Duration;
import java.time.Instant;
import java.util.stream.Collectors;

/**
 * REST controller in charge of computing arithmetic sequences.
 */
@RestController
@RequestMapping(&quot;/arithmetic-sequence&quot;)
public class ArithmeticSequenceController {

    /**
     * Service to non-reactively execute arithmetic sequence computation
     */
    private final MultipleArithmeticSequenceService nonReactiveService;

    /**
     * Service to reactively execute arithmetic sequence computation
     */
    private final ReactiveMultipleArithmeticSequenceService reactiveService;

    /**
     * Service to validate provided input parameters.
     */
    private final ArithmeticSequenceValidationService validationService;

    /**
     * Maps request parameters into domain entities.
     */
    private final MultipleArithmeticSequenceDataMapper dataMapper;

    /**
     * Maps result to API DTO's.
     */
    private final SingleArithmeticSequenceResultMapper resultMapper;

    /**
     * Creates DTO's for detailed results.
     */
    private final MultipleArithmeticSequenceDetailDtoFactory detailFactory;

    /**
     * Creates DTO's for summary results.
     */
    private final MultipleArithmeticSequenceSummaryDtoFactory summaryFactory;

    /**
     * Constructor.
     *
     * @param nonReactiveService Service to non-reactively execute arithmetic sequence computation.
     * @param reactiveService    Service to reactively execute arithmetic sequence computation.
     * @param validationService  Service to validate provided input parameters.
     * @param dataMapper         Maps request parameters into domain entities.
     * @param resultMapper       Maps result to API DTO's.
     * @param detailFactory      Creates DTO's for detailed results.
     * @param summaryFactory     Creates DTO's for summary results.
     */
    public ArithmeticSequenceController(final MultipleArithmeticSequenceService nonReactiveService,
                                        final ReactiveMultipleArithmeticSequenceService reactiveService,
                                        final ArithmeticSequenceValidationService validationService,
                                        final MultipleArithmeticSequenceDataMapper dataMapper,
                                        final SingleArithmeticSequenceResultMapper resultMapper,
                                        final MultipleArithmeticSequenceDetailDtoFactory detailFactory,
<span class="fc" id="L97">                                        final MultipleArithmeticSequenceSummaryDtoFactory summaryFactory) {</span>
<span class="fc" id="L98">        this.nonReactiveService = nonReactiveService;</span>
<span class="fc" id="L99">        this.reactiveService = reactiveService;</span>
<span class="fc" id="L100">        this.validationService = validationService;</span>
<span class="fc" id="L101">        this.dataMapper = dataMapper;</span>
<span class="fc" id="L102">        this.resultMapper = resultMapper;</span>
<span class="fc" id="L103">        this.detailFactory = detailFactory;</span>
<span class="fc" id="L104">        this.summaryFactory = summaryFactory;</span>
<span class="fc" id="L105">    }</span>

    /**
     * Non-reactively computes detailed results of arithmetic sequences.
     *
     * @param minValue       minimum value where arithmetic sequences will start.
     * @param step           step between values in computed arithmetic sequences.
     * @param count          number of arithmetic sequences to be computed (containing elements from 0 up to count).
     * @param sequenceMethod method used for arithmetic sequence computation. Can be either &quot;exhaustive&quot; or &quot;fast&quot;.
     * @return requested detailed results of arithmetic sequences.
     */
    @GetMapping(&quot;/non-reactive/detail&quot;)
    public MultipleArithmeticSequenceDetailDto computeDetailNonReactive(
            @RequestParam(&quot;minValue&quot;) final int minValue,
            @RequestParam(&quot;step&quot;) final int step,
            @RequestParam(&quot;count&quot;) final int count,
            @RequestParam(&quot;sequenceMethod&quot;) final String sequenceMethod) {

<span class="fc" id="L123">        validationService.validate(count);</span>

<span class="fc" id="L125">        final var startInstant = Instant.now();</span>

        // Notice that here a whole list of results is built. Memory usage will increase as count becomes larger
<span class="fc" id="L128">        final var results = nonReactiveService.compute(</span>
<span class="fc" id="L129">                dataMapper.mapFromDto(minValue, step, count, sequenceMethod)).stream()</span>
<span class="fc" id="L130">                .map(resultMapper::mapToDto).collect(Collectors.toList());</span>
<span class="fc" id="L131">        final var endInstant = Instant.now();</span>
<span class="fc" id="L132">        final var duration = Duration.between(startInstant, endInstant);</span>

<span class="fc" id="L134">        return detailFactory.build(results, duration);</span>
    }

    /**
     * Non-reactively computes summary results of arithmetic sequences.
     * Summary only contains total arithmetic sequences computed and their total sum, but
     * does not contain their detailed results.
     *
     * @param minValue       minimum value where arithmetic sequences will start.
     * @param step           step between values in computed arithmetic sequences.
     * @param count          number of arithmetic sequences to be computed (containing elements from 0 up to count).
     * @param sequenceMethod method used for arithmetic sequence computation. Can be either &quot;exhaustive&quot; or &quot;fast&quot;.
     * @return requested summary results of arithmetic sequences.
     */
    @GetMapping(&quot;/non-reactive/summary&quot;)
    public MultipleArithmeticSequenceSummaryDto computeSummaryNonReactive(
            @RequestParam(&quot;minValue&quot;) final int minValue,
            @RequestParam(&quot;step&quot;) final int step,
            @RequestParam(&quot;count&quot;) final int count,
            @RequestParam(&quot;sequenceMethod&quot;) final String sequenceMethod) {

<span class="fc" id="L155">        validationService.validate(count);</span>

<span class="fc" id="L157">        final var startInstant = Instant.now();</span>

        // Here also a whole list of results is built, even though all results are added up, stil the whole list needs
        // to be kept in memory. For this reason, memory usage will increase as count increases
<span class="fc" id="L161">        final var totalSum = (Long) nonReactiveService.compute(</span>
<span class="fc" id="L162">                dataMapper.mapFromDto(minValue, step, count, sequenceMethod)).stream()</span>
<span class="fc" id="L163">                .mapToLong(SingleArithmeticSequenceResult::getSum).sum();</span>

<span class="fc" id="L165">        final var endInstant = Instant.now();</span>
<span class="fc" id="L166">        final var duration = Duration.between(startInstant, endInstant);</span>

<span class="fc" id="L168">        return summaryFactory.build(totalSum, count, duration);</span>
    }

    /**
     * Reactively computes detailed results of arithmetic sequences.
     *
     * @param minValue       minimum value where arithmetic sequences will start.
     * @param step           step between values in computed arithmetic sequences.
     * @param count          number of arithmetic sequences to be computed (containing elements from 0 up to count).
     * @param sequenceMethod method used for arithmetic sequence computation. Can be either &quot;exhaustive&quot; or &quot;fast&quot;.
     * @return requested detailed results of arithmetic sequences.
     */
    @GetMapping(&quot;/reactive/detail&quot;)
    public Mono&lt;MultipleArithmeticSequenceDetailDto&gt; computeDetailReactive(
            @RequestParam(&quot;minValue&quot;) final int minValue,
            @RequestParam(&quot;step&quot;) final int step,
            @RequestParam(&quot;count&quot;) final int count,
            @RequestParam(&quot;sequenceMethod&quot;) final String sequenceMethod) {

<span class="fc" id="L187">        validationService.validate(count);</span>

<span class="fc" id="L189">        final var startInstant = Instant.now();</span>

        // Here results are also collected into a list, and consequently memory usage will increase as count increases.
<span class="fc" id="L192">        return reactiveService.compute(</span>
<span class="fc" id="L193">                dataMapper.mapFromDto(minValue, step, count, sequenceMethod))</span>
<span class="fc" id="L194">                .map(resultMapper::mapToDto).collectList().map(results -&gt; {</span>
<span class="fc" id="L195">                    final var endInstant = Instant.now();</span>
<span class="fc" id="L196">                    final var duration = Duration.between(startInstant, endInstant);</span>

<span class="fc" id="L198">                    return detailFactory.build(results, duration);</span>
                });
    }

    /**
     * Reactively computes summary results of arithmetic sequences.
     * Summary only contains total arithmetic sequences computed and their total sum, but
     * does not contain their detailed results.
     * Because this implementation is fully reactive, memory usage will remain constantly
     * low regardless of the number of requested arithmetic sequences to be computed.
     *
     * @param minValue       minimum value where arithmetic sequences will start.
     * @param step           step between values in computed arithmetic sequences.
     * @param count          number of arithmetic sequences to be computed (containing elements from 0 up to count).
     * @param sequenceMethod method used for arithmetic sequence computation. Can be either &quot;exhaustive&quot; or &quot;fast&quot;.
     * @return requested summary results of arithmetic sequences.
     */
    @GetMapping(&quot;/reactive/summary&quot;)
    public Mono&lt;MultipleArithmeticSequenceSummaryDto&gt; computeSummaryReactive(
            @RequestParam(&quot;minValue&quot;) final int minValue,
            @RequestParam(&quot;step&quot;) final int step,
            @RequestParam(&quot;count&quot;) final int count,
            @RequestParam(&quot;sequenceMethod&quot;) final String sequenceMethod) {

<span class="fc" id="L222">        validationService.validate(count);</span>

<span class="fc" id="L224">        final var startInstant = Instant.now();</span>

        // This is a fully reactive implementation. No lists are built in memory and memory usage will remain constant
        // regardless of count value
<span class="fc" id="L228">        return reactiveService.compute(</span>
<span class="fc" id="L229">                dataMapper.mapFromDto(minValue, step, count, sequenceMethod))</span>
<span class="fc" id="L230">                .map(item -&gt; (long) item.getSum())</span>
<span class="fc" id="L231">                .reduce(Long::sum).map(totalSum -&gt; {</span>

<span class="fc" id="L233">                    final var endInstant = Instant.now();</span>
<span class="fc" id="L234">                    final var duration = Duration.between(startInstant, endInstant);</span>

<span class="fc" id="L236">                    return summaryFactory.build(totalSum, count, duration);</span>
                });
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>